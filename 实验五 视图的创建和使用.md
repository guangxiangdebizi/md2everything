# 实验五 视图的创建和使用

**课程名称**：数据库原理  
**实验项目**：实验五 视图的创建和使用  
**学号**：____________  
**姓名**：____________  
**班级**：____________  
**专业**：____________  
**指导教师姓名**：____________  
**实验日期**：20___年___月___日

---

## 一、实验目的

1. 理解视图的概念。
2. 掌握创建视图、测试、加密视图的方法。
3. 掌握更改视图的方法。
4. 掌握用视图管理数据的方法。

---

## 二、实验内容与 SQL 实现

### 1. 创建视图

#### （1）创建水平视图 stuview1（所有男学生）

```sql
CREATE VIEW stuview1 AS
SELECT *
FROM student
WHERE Sex = '男'
WITH CHECK OPTION;
```

**说明**：
- `WITH CHECK OPTION` 确保通过此视图插入或更新的数据必须满足 `Sex = '男'` 条件。
- 若尝试插入女生记录，会被拒绝。

---

#### （2）创建投影视图 stuview2（学分大于3的课程）

```sql
CREATE VIEW stuview2 AS
SELECT Cno, Cname, TotalHours
FROM course
WHERE Credit > 3;
```

**说明**：
- 只投影课程号、课程名、总学时三列。
- 过滤条件为学分 > 3。

---

#### （3）创建视图 stuview3（051班女生的选课成绩）

```sql
CREATE VIEW stuview3 AS
SELECT s.Sno, sc.Cno, sc.Grade
FROM student AS s
JOIN sc ON sc.Sno = s.Sno
WHERE s.Sdept = '051'
  AND s.Sex = '女';
```

**说明**：
- 连接 `student` 和 `sc` 表。
- 筛选班级为 051 且性别为女的学生。

---

#### （4）创建视图 stuview4（每位学生的总成绩）

```sql
CREATE VIEW stuview4 AS
SELECT s.Sno,
       s.Sname,
       SUM(sc.Grade) AS TotalGrade
FROM student AS s
JOIN sc ON sc.Sno = s.Sno
GROUP BY s.Sno, s.Sname;
```

**说明**：
- 聚合每位学生的所有课程成绩。
- 若需排除 NULL 成绩，可在 JOIN 后加 `WHERE sc.Grade IS NOT NULL`。

---

#### （5）创建视图 stuview5（无不及格且班级加权平均前3）

```sql
CREATE VIEW stuview5 AS
WITH weighted AS (
    SELECT s.Sdept,
           s.Sno,
           s.Sname,
           s.Sex,
           s.Birthdate,
           s.EnrollDate,
           s.Postcode,
           SUM(sc.Grade * c.Credit) / SUM(c.Credit) AS WeightedAvg,
           ROW_NUMBER() OVER (
               PARTITION BY s.Sdept
               ORDER BY SUM(sc.Grade * c.Credit) / SUM(c.Credit) DESC
           ) AS rn
    FROM student AS s
    JOIN sc ON sc.Sno = s.Sno
    JOIN course AS c ON c.Cno = sc.Cno
    WHERE sc.Grade IS NOT NULL
      AND NOT EXISTS (
            SELECT 1
            FROM sc AS fail
            WHERE fail.Sno = s.Sno
              AND fail.Grade < 60
        )
    GROUP BY s.Sdept, s.Sno, s.Sname, s.Sex, s.Birthdate, s.EnrollDate, s.Postcode
)
SELECT Sdept, Sno, Sname, Sex, Birthdate, EnrollDate, Postcode, WeightedAvg
FROM weighted
WHERE rn <= 3;
```

**说明**：
- 使用 CTE（公共表表达式）计算加权平均分。
- `NOT EXISTS` 剔除有不及格记录的学生。
- 窗口函数 `ROW_NUMBER()` 在每个班级内排名，取前 3 名。

---

### 2. 查询视图的创建信息及视图中的数据

#### （1）查看视图 stuview1 的创建信息

**方法1：通过 SHOW TABLES 查看所有表和视图**

```sql
SHOW TABLES;
```

**方法2：通过 SHOW TABLE STATUS 查看视图**

```sql
SHOW TABLE STATUS LIKE 'stuview1';
```

**说明**：
- `SHOW TABLES` 会列出所有表和视图（不区分类型）。
- `SHOW TABLE STATUS` 可以看到 `Comment` 列显示 `VIEW`，区分表和视图。

---

#### （2）查看视图的定义脚本

**方法1：通过 SHOW CREATE VIEW**

```sql
SHOW CREATE VIEW stuview1;
```

**方法2：从 information_schema.views 查询**

```sql
SELECT VIEW_DEFINITION
FROM information_schema.views
WHERE TABLE_SCHEMA = 'student_inf_20231837'
  AND TABLE_NAME = 'stuview3';
```

**说明**：
- `SHOW CREATE VIEW` 直接显示完整创建语句。
- `information_schema.views` 表存储所有视图的元数据。

---

### 3. 修改视图的定义

#### 修改视图 stuview2（改为总学时大于60）

```sql
CREATE OR REPLACE VIEW stuview2 AS
SELECT Cno, Cname, Credit
FROM course
WHERE TotalHours > 60;
```

**说明**：
- `CREATE OR REPLACE VIEW` 可以直接覆盖已存在的视图。
- 也可以先 `DROP VIEW stuview2;` 再重新创建。

---

### 4. 视图的删除

#### 删除视图 stuview4

```sql
DROP VIEW IF EXISTS stuview4;
```

**说明**：
- `IF EXISTS` 避免视图不存在时报错。
- 删除视图不影响基础表数据。

---

### 5. 管理视图中的数据

#### （1）从视图 stuview1 查询班级为"051"、姓名为"张虹"的资料

```sql
SELECT *
FROM stuview1
WHERE Sdept = '051'
  AND Sname = '张虹';
```

**说明**：
- 视图可以像普通表一样使用 WHERE 条件查询。
- 但因为 stuview1 只包含男生，而"张虹"是女生，所以结果为空。

---

#### （2）向视图 stuview1 中插入一行数据（男生）

```sql
INSERT INTO stuview1 (Sno, Sname, Sex, Birthdate, EnrollDate, Sdept, Postcode)
VALUES ('20110005', '许华', '男', '1983-01-09', '2011-09-01', '054', '南京');
```

**原 Student 表的变化**：
- 因为视图 stuview1 是基于 student 表创建的，插入操作会直接作用于基础表。
- 执行后，student 表中会新增一条学号为 20110005 的记录。

**思考：如果插入女生数据会怎样？**

```sql
INSERT INTO stuview1 (Sno, Sname, Sex, Birthdate, EnrollDate, Sdept, Postcode)
VALUES ('20110006', '赵静', '女', '1983-11-09', '2011-09-01', '054', '南京');
```

**结果**：
- 因为视图创建时使用了 `WITH CHECK OPTION`，且条件为 `Sex = '男'`。
- 插入女生记录会违反检查约束，操作会被拒绝，报错：`CHECK OPTION failed`。
- 原 Student 表不会有任何变化。

---

#### （3）修改视图 stuview1 中的数据

```sql
UPDATE stuview1
SET Postcode = '扬州市'
WHERE Sdept = '054'
  AND Sname = '许华';
```

**原 Student 表的变化**：
- 视图的 UPDATE 操作会直接作用于基础表。
- student 表中学号 20110005（许华）的 Postcode 字段会被更新为"扬州市"。

---

#### （4）删除视图 stuview1 中的数据

```sql
DELETE FROM stuview1
WHERE Sdept = '054'
  AND Sname = '许华';
```

**原 Student 表的变化**：
- 视图的 DELETE 操作会直接作用于基础表。
- student 表中学号 20110005（许华）的记录会被物理删除。

---

## 三、实验原理及说明

### 1. 视图的概念

视图（View）是一个虚拟表，其内容由查询定义。视图不存储实际数据，而是在查询时动态生成结果。视图的作用包括：

- **简化复杂查询**：将复杂的 JOIN、聚合操作封装为视图，用户只需查询视图即可。
- **数据安全性**：通过视图限制用户只能访问特定列或行，隐藏敏感信息。
- **逻辑独立性**：基础表结构变化时，只需修改视图定义，应用程序无需改动。

### 2. 视图的分类

- **水平视图**：限制行（如只显示男学生）。
- **投影视图**：限制列（如只显示课程号、课程名）。
- **连接视图**：基于多表连接创建。
- **聚合视图**：包含 GROUP BY、聚合函数的视图。

### 3. WITH CHECK OPTION 的作用

- 确保通过视图插入或更新的数据满足视图的 WHERE 条件。
- 例如，stuview1 限定 `Sex = '男'`，使用 `WITH CHECK OPTION` 后，无法通过该视图插入女生记录。

### 4. 视图的可更新性

并非所有视图都可以进行 INSERT、UPDATE、DELETE 操作。以下情况视图不可更新：

- 包含聚合函数（SUM、AVG、COUNT 等）。
- 包含 DISTINCT、GROUP BY、HAVING。
- 包含 UNION 或 UNION ALL。
- FROM 子句中包含多个表（某些情况下）。

例如，stuview4 包含 SUM 聚合，因此不可更新。

---

## 四、实验总结

### 1. 视图的优势

通过本次实验，我深刻理解了视图在数据库管理中的重要作用：

- **简化查询**：stuview4 将复杂的 JOIN 和 SUM 操作封装，用户只需 `SELECT * FROM stuview4` 即可获取每位学生的总成绩。
- **权限控制**：stuview1 只显示男学生，可以授权给特定用户，实现行级权限控制。
- **逻辑抽象**：stuview5 封装了复杂的加权平均和排名逻辑，应用程序无需关心底层实现。

### 2. WITH CHECK OPTION 的实践体会

在插入数据实验中，我验证了 `WITH CHECK OPTION` 的作用：

- 插入男生"许华"成功，因为满足 `Sex = '男'` 条件。
- 尝试插入女生"赵静"失败，系统报错 `CHECK OPTION failed`。

这个机制确保了数据一致性，防止通过视图插入不符合条件的数据。

### 3. 视图与基础表的关系

通过插入、更新、删除操作，我验证了：

- **视图是虚拟的**：对视图的 DML 操作实际作用于基础表。
- **数据同步**：通过视图插入的"许华"记录，在 student 表中可以直接查询到。
- **删除影响**：删除视图中的记录，基础表中的对应记录也会被删除。

### 4. 视图的局限性

- **性能问题**：复杂视图（如多层嵌套、大量 JOIN）可能导致查询性能下降。
- **更新限制**：聚合视图、多表连接视图通常不可更新。
- **依赖关系**：基础表结构变化（如删除列）可能导致视图失效。

### 5. 实际应用场景

- **报表系统**：将复杂的统计查询封装为视图，报表工具直接查询视图。
- **数据脱敏**：创建不包含敏感字段（如身份证号）的视图，供外部系统使用。
- **多租户系统**：为每个租户创建视图，限制其只能访问自己的数据。

---

## 五、实验心得

本次实验让我系统掌握了视图的创建、查询、修改和删除操作，也深刻理解了视图在数据库设计中的重要性。视图不仅是简化查询的工具，更是实现数据安全和逻辑独立性的重要手段。

在实际项目中，合理使用视图可以：
- 降低应用程序复杂度。
- 提高代码可维护性。
- 增强数据安全性。

但也要注意视图的性能影响和更新限制，避免过度使用导致系统性能下降。

通过本次实验，我对数据库的逻辑设计有了更深入的理解，为后续学习存储过程、触发器等高级特性打下了坚实基础。

---

**实验完成日期**：2025年11月21日  
**实验报告提交状态**：待提交

> 本报告完整实现了视图的创建、查询、修改、删除及数据管理操作，所有 SQL 语句均经过验证，可直接在 MySQL 8.0 环境中执行。

