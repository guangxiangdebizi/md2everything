<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown æ¸²æŸ“å™¨ - æ”¯æŒ Mermaid å’Œæ•°å­¦å…¬å¼</title>
    
    <!-- MathJax é…ç½® -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <!-- html2canvas for converting SVG to image -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11/marked.min.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- html2pdf for better PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- docx for Word export -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .export-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: none;
        }
        
        .export-section.show {
            display: block;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .export-btn:active {
            transform: translateY(0);
        }
        
        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .export-btn .icon {
            font-size: 1.2em;
        }
        
        .file-info strong {
            color: #667eea;
        }
        
        .preview-section {
            padding: 40px;
            min-height: 400px;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }
        
        .preview-placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        #preview {
            line-height: 1.8;
            color: #333;
        }
        
        /* Markdown æ ·å¼ */
        #preview h1 {
            font-size: 2.5em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
        
        #preview h2 {
            font-size: 2em;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
        }
        
        #preview h3 {
            font-size: 1.5em;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            color: #6c757d;
        }
        
        #preview h4 {
            font-size: 1.2em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #868e96;
        }
        
        #preview p {
            margin-bottom: 1em;
        }
        
        #preview ul, #preview ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        
        #preview li {
            margin-bottom: 0.5em;
        }
        
        #preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5em 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #preview table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        #preview table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        #preview table tr:hover {
            background: #f8f9fa;
        }
        
        #preview code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }
        
        #preview pre {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5em 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        #preview pre code {
            background: transparent;
            padding: 0;
            color: inherit;
            font-size: 0.9em;
        }
        
        #preview blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 1.5em 0;
            color: #6c757d;
            font-style: italic;
        }
        
        #preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin: 1.5em 0;
        }
        
        /* Mermaid å›¾è¡¨æ ·å¼ */
        .mermaid-container {
            text-align: center;
            margin: 2em 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .mermaid {
            display: inline-block;
            max-width: 100%;
        }
        
        .mermaid-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mermaid-container:hover .mermaid-actions {
            opacity: 1;
        }
        
        .mermaid-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .mermaid-btn:hover {
            background: #764ba2;
        }
        
        .mermaid-btn:active {
            transform: scale(0.95);
        }
        
        .mermaid-tip {
            font-size: 12px;
            color: #6c757d;
            margin-top: 10px;
            font-style: italic;
        }
        
        svg {
            max-width: 100%;
            height: auto;
        }
        
        /* MathJax å…¬å¼æ ·å¼ */
        .MathJax {
            margin: 1em 0;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .preview-section {
                padding: 20px;
            }
            
            #preview h1 {
                font-size: 2em;
            }
            
            #preview h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Markdown æ¸²æŸ“å™¨</h1>
            <p>æ”¯æŒ Mermaid å›¾è¡¨å’Œæ•°å­¦å…¬å¼æ¸²æŸ“</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Markdown æ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ .md å’Œ .markdown æ ¼å¼</div>
                <input type="file" id="fileInput" accept=".md,.markdown">
            </div>
            <div class="file-info" id="fileInfo"></div>
        </div>
        
        <div class="export-section" id="exportSection">
            <div class="export-buttons">
                <button class="export-btn" id="exportPdfBtn" onclick="exportToPDF()">
                    <span class="icon">ğŸ“¥</span>
                    <span>å¯¼å‡ºä¸º PDF</span>
                </button>
                <button class="export-btn" id="exportDocxBtn" onclick="exportToDocx()">
                    <span class="icon">ğŸ“¥</span>
                    <span>å¯¼å‡ºä¸º Word (DOCX)</span>
                </button>
                <button class="export-btn" id="exportHtmlBtn" onclick="exportToHTML()">
                    <span class="icon">ğŸ“¥</span>
                    <span>å¯¼å‡ºä¸º HTML</span>
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea;">æ­£åœ¨æ¸²æŸ“...</p>
        </div>
        
        <div class="preview-section">
            <div class="preview-placeholder" id="placeholder">
                <div class="preview-placeholder-icon">ğŸ“–</div>
                <h2>ç­‰å¾…ä¸Šä¼ æ–‡ä»¶</h2>
                <p>è¯·ä¸Šä¼ ä¸€ä¸ª Markdown æ–‡ä»¶å¼€å§‹é¢„è§ˆ</p>
            </div>
            <div id="preview" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            securityLevel: 'loose'
        });
        
        // é…ç½® Marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const exportSection = document.getElementById('exportSection');
        
        let currentFileName = 'document';
        let currentContent = '';
        
        // HTMLè½¬ä¹‰è¾…åŠ©å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });
        
        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown'))) {
                handleFile(file);
            } else {
                alert('è¯·ä¸Šä¼  .md æˆ– .markdown æ ¼å¼çš„æ–‡ä»¶');
            }
        });
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            // ä¿å­˜æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
            currentFileName = file.name.replace(/\.(md|markdown)$/i, '');
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileInfo.innerHTML = `
                <strong>æ–‡ä»¶åï¼š</strong>${file.name}<br>
                <strong>å¤§å°ï¼š</strong>${(file.size / 1024).toFixed(2)} KB<br>
                <strong>ç±»å‹ï¼š</strong>${file.type || 'text/markdown'}
            `;
            fileInfo.classList.add('show');
            
            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = (e) => {
                currentContent = e.target.result;
                renderMarkdown(currentContent);
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // æ¸²æŸ“ Markdown
        function renderMarkdown(content) {
            loading.classList.add('show');
            placeholder.style.display = 'none';
            preview.style.display = 'none';
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿ UI æ›´æ–°
            setTimeout(() => {
                // é…ç½® Marked ä»¥ä¿ç•™åŸå§‹ä»£ç å—
                const renderer = new marked.Renderer();
                const originalCode = renderer.code.bind(renderer);
                
                renderer.code = function(code, language) {
                    // å¦‚æœæ˜¯ mermaid ä»£ç å—ï¼Œè¿”å›ç‰¹æ®Šæ ‡è®°
                    if (language === 'mermaid') {
                        const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                        return `<div class="mermaid-container" data-mermaid-id="${id}">
                            <div class="mermaid-actions">
                                <button class="mermaid-btn" onclick="downloadMermaidAsPNG('${id}')" title="ä¸‹è½½ä¸ºPNGå›¾ç‰‡">ğŸ“¥ PNG</button>
                                <button class="mermaid-btn" onclick="downloadMermaidAsSVG('${id}')" title="ä¸‹è½½ä¸ºSVGå›¾ç‰‡">ğŸ“¥ SVG</button>
                            </div>
                            <div class="mermaid" id="${id}" data-mermaid-code="${escapeHtml(code.trim())}">${escapeHtml(code.trim())}</div>
                            <div class="mermaid-tip">ğŸ’¡ æç¤ºï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ï¼Œå³é”®å›¾è¡¨å¯å¿«é€Ÿä¿å­˜ä¸ºPNG</div>
                        </div>`;
                    }
                    // å…¶ä»–ä»£ç å—ä½¿ç”¨é»˜è®¤æ¸²æŸ“
                    return originalCode(code, language);
                };
                
                // è§£æ Markdownï¼ˆä½¿ç”¨è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼‰
                let html = marked.parse(content, { renderer: renderer });
                
                // è®¾ç½®é¢„è§ˆå†…å®¹
                preview.innerHTML = html;
                preview.style.display = 'block';
                
                // ç­‰å¾…DOMæ›´æ–°åæ¸²æŸ“ Mermaid å›¾è¡¨
                setTimeout(() => {
                    renderMermaidCharts();
                }, 200);
                
                // æ¸²æŸ“æ‰€æœ‰ Mermaid å›¾è¡¨çš„å‡½æ•°
                async function renderMermaidCharts() {
                    const mermaidElements = preview.querySelectorAll('.mermaid');
                    if (mermaidElements.length === 0) {
                        loading.classList.remove('show');
                        return;
                    }
                    
                    const renderPromises = Array.from(mermaidElements).map(async (element, index) => {
                        // ä»dataå±æ€§æˆ–textContentè·å–ä»£ç 
                        const code = element.getAttribute('data-mermaid-code') || element.textContent.trim();
                        const id = element.id;
                        
                        if (!code) {
                            console.warn(`Mermaidå…ƒç´  ${id} æ²¡æœ‰ä»£ç å†…å®¹`);
                            return { success: false, id, error: 'No code content' };
                        }
                        
                        try {
                            // æ¸…ç©ºå…ƒç´ å†…å®¹ï¼Œå‡†å¤‡æ¸²æŸ“
                            element.textContent = '';
                            
                            // ä½¿ç”¨ Mermaid API æ¸²æŸ“
                            const uniqueId = `mermaid-diagram-${id}-${index}-${Date.now()}`;
                            const { svg } = await mermaid.render(uniqueId, code);
                            
                            // æ’å…¥æ¸²æŸ“åçš„SVG
                            element.innerHTML = svg;
                            
                            // æ·»åŠ å³é”®ä¿å­˜åŠŸèƒ½
                            const svgElement = element.querySelector('svg');
                            if (svgElement) {
                                svgElement.style.cursor = 'pointer';
                                svgElement.addEventListener('contextmenu', (e) => {
                                    e.preventDefault();
                                    downloadMermaidAsPNG(id);
                                });
                            }
                            
                            console.log(`Mermaidå›¾è¡¨ ${id} æ¸²æŸ“æˆåŠŸ`);
                            return { success: true, id };
                        } catch (error) {
                            console.error(`Mermaid æ¸²æŸ“é”™è¯¯ [${id}]:`, error);
                            element.innerHTML = `<div style="color: red; padding: 20px; border: 1px solid red; border-radius: 4px;">
                                <strong>å›¾è¡¨æ¸²æŸ“å¤±è´¥</strong><br>
                                é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                                <small>ä»£ç é¢„è§ˆ: ${code.substring(0, 100)}...</small>
                            </div>`;
                            return { success: false, id, error: error.message };
                        }
                    });
                    
                    // ç­‰å¾…æ‰€æœ‰ Mermaid å›¾è¡¨æ¸²æŸ“å®Œæˆ
                    try {
                        const results = await Promise.all(renderPromises);
                        const successCount = results.filter(r => r.success).length;
                        console.log(`âœ… Mermaid å›¾è¡¨æ¸²æŸ“å®Œæˆ: ${successCount}/${results.length} æˆåŠŸ`);
                        
                        if (successCount < results.length) {
                            console.warn('éƒ¨åˆ†å›¾è¡¨æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
                        }
                    } catch (error) {
                        console.error('Mermaid æ¸²æŸ“è¿‡ç¨‹å‡ºé”™:', error);
                    } finally {
                        loading.classList.remove('show');
                        // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®åŒºåŸŸ
                        exportSection.classList.add('show');
                    }
                }
                
                // æ¸²æŸ“ä»£ç é«˜äº®
                preview.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).then(() => {
                        loading.classList.remove('show');
                    }).catch((err) => {
                        console.error('MathJax æ¸²æŸ“é”™è¯¯:', err);
                        loading.classList.remove('show');
                    });
                } else {
                    loading.classList.remove('show');
                }
            }, 100);
        }
        
        // ä¸‹è½½ Mermaid å›¾è¡¨ä¸º PNG
        async function downloadMermaidAsPNG(mermaidId) {
            const element = document.getElementById(mermaidId);
            if (!element) return;
            
            const container = element.closest('.mermaid-container');
            if (!container) return;
            
            try {
                // éšè—æ“ä½œæŒ‰é’®
                const actions = container.querySelector('.mermaid-actions');
                if (actions) actions.style.display = 'none';
                
                // ä½¿ç”¨ html2canvas è½¬æ¢ä¸ºå›¾ç‰‡
                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                // æ¢å¤æ“ä½œæŒ‰é’®
                if (actions) actions.style.display = 'flex';
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mermaid-chart-${mermaidId}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('PNG å¯¼å‡ºé”™è¯¯:', error);
                alert('å¯¼å‡º PNG å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä¸‹è½½ Mermaid å›¾è¡¨ä¸º SVG
        function downloadMermaidAsSVG(mermaidId) {
            const element = document.getElementById(mermaidId);
            if (!element) return;
            
            const svgElement = element.querySelector('svg');
            if (!svgElement) {
                alert('æœªæ‰¾åˆ° SVG å…ƒç´ ');
                return;
            }
            
            try {
                // å…‹éš† SVG å…ƒç´ 
                const svgClone = svgElement.cloneNode(true);
                
                // è®¾ç½® SVG å±æ€§
                const svgData = new XMLSerializer().serializeToString(svgClone);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const svgUrl = URL.createObjectURL(svgBlob);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = svgUrl;
                a.download = `mermaid-chart-${mermaidId}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(svgUrl);
            } catch (error) {
                console.error('SVG å¯¼å‡ºé”™è¯¯:', error);
                alert('å¯¼å‡º SVG å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¯¼å‡ºä¸º PDF
        async function exportToPDF() {
            const exportBtn = document.getElementById('exportPdfBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="icon">â³</span><span>æ­£åœ¨ç”Ÿæˆ PDF...</span>';
            
            try {
                const element = document.getElementById('preview');
                
                // é…ç½®é€‰é¡¹
                const opt = {
                    margin: [10, 10],
                    filename: `${currentFileName}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                // ç”Ÿæˆ PDF
                await html2pdf().set(opt).from(element).save();
                
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">âœ…</span><span>å¯¼å‡ºæˆåŠŸï¼</span>';
                setTimeout(() => {
                    exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º PDF</span>';
                }, 2000);
            } catch (error) {
                console.error('PDF å¯¼å‡ºé”™è¯¯:', error);
                alert('PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º PDF</span>';
            }
        }
        
        // å¯¼å‡ºä¸º Word (DOCX)
        async function exportToDocx() {
            const exportBtn = document.getElementById('exportDocxBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="icon">â³</span><span>æ­£åœ¨ç”Ÿæˆ Word...</span>';
            
            try {
                // ç”±äº docx.js åº“çš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–æ–¹æ¡ˆï¼šå¯¼å‡ºä¸º HTML æ ¼å¼çš„ Word æ–‡æ¡£
                const element = document.getElementById('preview');
                let htmlContent = element.innerHTML;
                
                // æ·»åŠ æ ·å¼
                const styledHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: "Microsoft YaHei", Arial, sans-serif; line-height: 1.8; padding: 40px; }
                            h1 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
                            h2 { color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; margin-top: 30px; }
                            h3 { color: #6c757d; margin-top: 25px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            table th { background: #667eea; color: white; padding: 12px; text-align: left; }
                            table td { padding: 10px 12px; border-bottom: 1px solid #e9ecef; }
                            code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
                            pre { background: #282c34; color: #abb2bf; padding: 20px; border-radius: 8px; }
                            .mermaid-tip { display: none; }
                            .mermaid-actions { display: none; }
                        </style>
                    </head>
                    <body>
                        ${htmlContent}
                    </body>
                    </html>
                `;
                
                // åˆ›å»º Blob
                const blob = new Blob(['\ufeff', styledHtml], {
                    type: 'application/msword'
                });
                
                // ä¸‹è½½
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentFileName}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">âœ…</span><span>å¯¼å‡ºæˆåŠŸï¼</span>';
                setTimeout(() => {
                    exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º Word (DOCX)</span>';
                }, 2000);
            } catch (error) {
                console.error('Word å¯¼å‡ºé”™è¯¯:', error);
                alert('Word å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º Word (DOCX)</span>';
            }
        }
        
        // å¯¼å‡ºä¸º HTML
        function exportToHTML() {
            const exportBtn = document.getElementById('exportHtmlBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="icon">â³</span><span>æ­£åœ¨ç”Ÿæˆ HTML...</span>';
            
            try {
                const element = document.getElementById('preview');
                let htmlContent = element.innerHTML;
                
                // åˆ›å»ºå®Œæ•´çš„ HTML æ–‡æ¡£
                const fullHtml = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${currentFileName}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.8;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8f9fa;
        }
        .content {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5em; margin-top: 1em; margin-bottom: 0.5em; padding-bottom: 0.3em; border-bottom: 3px solid #667eea; color: #667eea; }
        h2 { font-size: 2em; margin-top: 1.5em; margin-bottom: 0.5em; padding-bottom: 0.3em; border-bottom: 2px solid #e9ecef; color: #495057; }
        h3 { font-size: 1.5em; margin-top: 1.2em; margin-bottom: 0.5em; color: #6c757d; }
        h4 { font-size: 1.2em; margin-top: 1em; margin-bottom: 0.5em; color: #868e96; }
        p { margin-bottom: 1em; }
        ul, ol { margin-bottom: 1em; padding-left: 2em; }
        li { margin-bottom: 0.5em; }
        table { width: 100%; border-collapse: collapse; margin: 1.5em 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; text-align: left; font-weight: 600; }
        table td { padding: 10px 12px; border-bottom: 1px solid #e9ecef; }
        table tr:hover { background: #f8f9fa; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; color: #e83e8c; }
        pre { background: #282c34; color: #abb2bf; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 1.5em 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        pre code { background: transparent; padding: 0; color: inherit; font-size: 0.9em; }
        blockquote { border-left: 4px solid #667eea; padding-left: 20px; margin: 1.5em 0; color: #6c757d; font-style: italic; }
        img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 1.5em 0; }
        .mermaid-container { text-align: center; margin: 2em 0; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .mermaid-tip { display: none; }
        .mermaid-actions { display: none; }
        svg { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <div class="content">
        ${htmlContent}
    </div>
</body>
</html>`;
                
                // åˆ›å»º Blob å¹¶ä¸‹è½½
                const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentFileName}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">âœ…</span><span>å¯¼å‡ºæˆåŠŸï¼</span>';
                setTimeout(() => {
                    exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º HTML</span>';
                }, 2000);
            } catch (error) {
                console.error('HTML å¯¼å‡ºé”™è¯¯:', error);
                alert('HTML å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="icon">ğŸ“¥</span><span>å¯¼å‡ºä¸º HTML</span>';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœæœ‰é»˜è®¤æ–‡ä»¶ï¼Œå¯ä»¥è‡ªåŠ¨åŠ è½½
        // è¿™é‡Œå¯ä»¥æ·»åŠ ä» URL å‚æ•°è¯»å–æ–‡ä»¶è·¯å¾„çš„é€»è¾‘
    </script>
</body>
</html>

